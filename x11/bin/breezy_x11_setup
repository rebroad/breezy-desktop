#!/usr/bin/env bash

set -e

echo "Setting up Breezy Desktop for X11/Xorg (development mode)..."

# Check if running on X11
if [ -z "$XDG_SESSION_TYPE" ] || [[ ! "$XDG_SESSION_TYPE" =~ [Xx]11 ]]; then
    echo "Warning: This setup script is for X11/Xorg. Current session: $XDG_SESSION_TYPE"
    read -p "Continue anyway? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

# Check for required commands
check_command() {
    for cmd in "$@"; do
        if command -v "$cmd" &>/dev/null; then
            return
        fi
    done

    echo "Please install one of the following: ${*}, and make sure it's available in your \$PATH, then rerun the setup."
    exit 1
}

check_command "xrandr"
check_command "python" "python3"

# Get script directory and repo root (treat repo as the install location)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BREEZY_DIR="$(cd "$SCRIPT_DIR/../.." && pwd)"

# Make the breezy-desktop tree importable in dev mode via a .pth file
echo "Registering breezy-desktop source tree with Python (user site-packages)..."
PYTHON_SITE_PACKAGES=$(python3 -c "import site; print(site.getusersitepackages())" 2>/dev/null || python3 -c "import site; print(site.USER_SITE)")
mkdir -p "$PYTHON_SITE_PACKAGES"
echo "$BREEZY_DIR" > "$PYTHON_SITE_PACKAGES/breezy_desktop_dev.pth"

echo ""
echo "Breezy Desktop X11 setup complete!"
echo ""
echo "This script sets up the development environment for Breezy Desktop on X11."
echo "For production use, install Breezy Desktop as a package instead."
echo ""
echo "Prerequisites for X11 backend:"
echo "  - Xorg with modesetting driver (standard on most Linux distributions)"
echo "  - Xorg modesetting driver with virtual XR output support (XR-Manager)"
echo ""
echo "The X11 backend uses virtual XR outputs (XR-0, XR-1, etc.) created via"
echo "the Xorg modesetting driver, not the dummy driver."
echo ""
echo "You can now launch Breezy Desktop from the applications menu."

